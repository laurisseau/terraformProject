---
- name: Setup DynamoDB for Terraform State Locking
  hosts: dynamodb
  become: yes
  vars:
    aws_region: "us-east-1"
    dynamodb_table_name: "terraform-state-lock"
    terraform_user: "dynamodb"
    
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required system packages
      apt:
        name:
          - python3-pip
        state: present

    - name: Install Boto3 and Botocore
      apt:
        name:
          - python3-boto3
          - python3-botocore
        state: present
        update_cache: yes

    - name: Get credentials from AWS Secrets Manager
      ansible.builtin.set_fact:
        aws_secrets: "{{ lookup('amazon.aws.aws_secret', 'sportsify-dev-secrets') }}"

    - name: Install and setup AWS CLI v2
      block:
        - name: Install unzip (required for AWS CLI bundle)
          ansible.builtin.apt:
            name: unzip
            state: present
            update_cache: yes

        - name: Download AWS CLI v2 installation bundle
          ansible.builtin.get_url:
            url: "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip"
            dest: "/tmp/awscliv2.zip"
            mode: '0755'

        - name: Unzip the AWS CLI bundle
          ansible.builtin.unarchive:
            src: "/tmp/awscliv2.zip"
            dest: "/tmp"
            remote_src: yes
            creates: "/tmp/aws"

        - name: Install AWS CLI v2
          ansible.builtin.command:
            cmd: /tmp/aws/install
            creates: "/usr/local/bin/aws"
      become: yes

    - name: Create Terraform user
      user:
        name: "{{ terraform_user }}"
        shell: /bin/bash
        create_home: yes
        state: present

    - name: Configure AWS credentials directory
      file:
        path: "/home/{{ terraform_user }}/.aws"
        state: directory
        owner: "{{ terraform_user }}"
        group: "{{ terraform_user }}"
        mode: '0700'

    - name: Create AWS credentials file
      template:
        src: aws_credentials.j2
        dest: "/home/{{ terraform_user }}/.aws/credentials"
        owner: "{{ terraform_user }}"
        group: "{{ terraform_user }}"
        mode: '0600'
      when: aws_access_key is defined and aws_secret_key is defined

    - name: Create AWS config file
      copy:
        content: |
          [default]
          region = {{ aws_region }}
          output = json
        dest: "/home/{{ terraform_user }}/.aws/config"
        owner: "{{ terraform_user }}"
        group: "{{ terraform_user }}"
        mode: '0600'

    - name: Create DynamoDB Table for Terraform State Locking
      community.aws.dynamodb_table:
        name: "{{ dynamodb_table_name }}"
        access_key: "{{ aws_secrets.AWS_ACCESS_KEY_ID }}"
        secret_key: "{{ aws_secrets.AWS_SECRET_ACCESS_KEY }}"
        region: "{{ aws_region }}"
        billing_mode: PAY_PER_REQUEST
        hash_key_name: LockID
        hash_key_type: STRING
        tags:
          Purpose: TerraformStateLocking
          ManagedBy: Ansible
      register: dynamodb_table

    - name: Display completion message
      debug:
        msg: |
          DynamoDB setup complete!
          
          Table Name: {{ dynamodb_table_name }}
          AWS Region: {{ aws_region }}